<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>보험 약관 검색 - AI 추천 시스템</title>
    <!-- Bootstrap CSS (필수) -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .nav-btn {
            display: inline-block;
            margin: 0 8px;
            padding: 8px 22px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
            font-weight: bold;
            border-radius: 25px;
            text-decoration: none;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.11);
        }
        .nav-btn:hover { background: linear-gradient(135deg, #667eea, #764ba2); }

        .search-section { padding: 40px; }
        .search-box { position: relative; margin-bottom: 30px; }
        .search-input {
            width: 100%; padding: 20px 60px 20px 20px; font-size: 16px;
            border: 2px solid #e0e0e0; border-radius: 50px;
            outline: none; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 5px 25px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .search-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: linear-gradient(135deg, #3498db, #2980b9); color: #fff;
            border: none; padding: 15px 20px; border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease; font-weight: bold;
        }
        .search-btn:hover { transform: translateY(-50%) scale(1.05); box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3); }
        .search-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: translateY(-50%); }
        .loading { display: none; text-align: center; padding: 20px; color: #666; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .results { display: none; }
        .result-item { background: #f8f9fa; border-left: 5px solid #3498db; margin-bottom: 20px; padding: 25px; border-radius: 10px; transition: all 0.3s ease; animation: slideIn 0.5s ease forwards; }
        .result-item:hover { transform: translateX(5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .similarity-score { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: auto; }
        .document-name { color: #3498db; font-weight: bold; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .result-text { color: #2c3e50; line-height: 1.6; font-size: 1.05em; }
        .no-results { text-align: center; padding: 40px; color: #666; font-size: 1.1em; }
        .example-queries { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .example-queries h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; }
        .example-query { display: inline-block; background: #fff; color: #3498db; padding: 8px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #3498db; font-size: 0.9em; }
        .example-query:hover { background: #3498db; color: #fff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
        .footer { background: #2c3e50; color: #fff; text-align: center; padding: 20px; font-size: 0.9em; opacity: 0.8; }

        /* 우측 플로팅 챗봇 */
        #chatbot-fab { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; border-radius: 50%; background: #3498db; color: #fff; display:flex; align-items:center; justify-content:center; cursor: pointer; z-index: 9998; box-shadow: 0 8px 20px rgba(0,0,0,0.2); font-weight:600; }
        #chatbot-container { position: fixed; right: 20px; bottom: 86px; width: 360px; height: 520px; background: #fff; border-radius: 12px; box-shadow: 0 12px 28px rgba(0,0,0,0.18); display: none; flex-direction: column; overflow: auto; z-index: 9999; resize: both; min-width: 280px; min-height: 360px; max-width: 90vw; max-height: 90vh; }
        #chatbot-header { padding: 10px 12px; background: #2c3e50; color: #fff; font-weight: 600; display:flex; align-items:center; justify-content:space-between; cursor: move; }
        #chatbot-messages { flex: 1; padding: 12px; overflow-y: auto; background:#f7f9fc; }
        .msg { margin-bottom: 12px; max-width: 85%; line-height:1.5; }
        .user { margin-left:auto; background:#e9f2ff; border:1px solid #c9e0ff; padding:8px 10px; border-radius:10px; }
        .bot { margin-right:auto; background:#fff; border:1px solid #e6e6e6; padding:8px 10px; border-radius:10px; }
        .meta { font-size:12px; color:#777; margin-top: 6px; }
        #chatbot-input { display:flex; border-top:1px solid #e6e6e6; }
        #chatbot-input input { flex:1; border:none; padding:12px; font-size:14px; outline:none; }
        #chatbot-input button { width:86px; background:#3498db; color:#fff; border:none; font-weight:600; }
        .clarify-list button { margin-right:6px; margin-top:6px; padding:6px 8px; border:1px solid #d0d7de; background:#fff; border-radius:8px; cursor:pointer; }
        details.source { background:#fff; border:1px solid #e6e6e6; border-radius:8px; padding:8px 10px; margin-top:8px; }
        .bot table { width: 100%; border-collapse: collapse; margin-top: 6px; }
        .bot th, .bot td { border: 1px solid #e6e6e6; padding: 6px 8px; font-size: 13px; }
        .bot th { background: #f2f6ff; text-align: left; }

        /* 주간 정보 플로팅 버튼 */
        #weekly-fab {
            position: fixed;
            right: 20px;
            top: calc(50% - 100px);
            height: 60px;
            padding: 0 14px;
            border-radius: 20px;
            background: #ffffff;
            color: #3498db;
            border: 2px solid #3498db;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            text-decoration: none;
        }
        #weekly-fab:hover { background: #3498db; color: #fff; }

        /* 사고처리 가이드/주간정보 플로팅 버튼 */
        #guide-fab, #weekly-fab {
            position: fixed; right: 20px;
            height: 40px; padding: 0 14px;
            border-radius: 20px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 9998; text-decoration: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        #guide-fab { background:#fff; color:#7e57c2; border:2px solid #7e57c2; }
        #guide-fab:hover { background:#7e57c2; color:#fff; }
        #weekly-fab { background:#fff; color:#3498db; border:2px solid #3498db; }
        #weekly-fab:hover { background:#3498db; color:#fff; }
        #guide-fab  { top: calc(50% - 160px); }

        /* ==== 모달 스크롤 보장 ==== */
        #guideModal .modal-body { max-height: 70vh; overflow: auto; }

        /* ==== 이미지 스타일 카드 2줄 그리드 ==== */
        .guide-grid{
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2열 */
        gap: 16px;
        padding: 8px 6px 12px;
        }
        .guide-grid > .guide-card{
            scroll-snap-align: start;
            background:#fff;
            border:1px solid #e8ebf0;
            border-radius:14px;
            padding:18px 16px;
            box-shadow:0 8px 18px rgba(0,0,0,0.05);
        }

        /* 카드 헤더/배지 */
        .guide-card .head{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .guide-card .step-badge{
            width:40px; height:40px; border-radius:12px;
            display:flex; align-items:center; justify-content:center;
            background:#eef3ff; color:#2f5bd3; font-weight:800;
            border:1px solid #dfe8ff;
        }
        .guide-card .title{ font-weight:700; color:#1f2d3d; }
        .guide-card .subtitle{ color:#6b7785; font-size:13px; margin:6px 0 4px; }
        .guide-card ul{ margin:8px 0 0; padding-left:18px; color:#2c3e50; }
        .guide-card li{ margin:3px 0; font-size:14px; line-height:1.5; }
        .guide-card .btn-toggle{ margin-top:10px; }

        /* 카드 썸네일 */
        .guide-card .thumb{
            width:100%;
            aspect-ratio:1/1;
            background:#f5f7fb;
            border-radius:12px;
            overflow:hidden;
            margin-bottom:12px;
            border:1px solid #eef0f5;
        }
        .guide-card .thumb img{
            width:100%; height:100%;
            object-fit:cover; display:block;
        }
        /* ==== 하단(피해물/피해자) 섹션 카드 UI ==== */
        .flow-section { margin-top: 20px; }
        .flow-toggle {
        display:inline-flex; align-items:center; gap:8px;
        border:1px solid #d0d7de; background:#fff; border-radius:10px;
        padding:8px 12px; font-weight:600; cursor:pointer;
        }
        .flow-toggle:hover { background:#f6f8fa; }
        .flow-list { margin-top:10px; }
        .flow-card{
        background:#fff; border:1px solid #e8ebf0; border-radius:12px;
        padding:14px; margin-bottom:10px;
        box-shadow:0 6px 14px rgba(0,0,0,0.04);
        }
        .flow-card .flow-head{
        display:flex; align-items:center; gap:8px; margin-bottom:6px;
        }
        .flow-card .flow-badge{
        min-width:34px; height:34px; border-radius:10px;
        display:flex; align-items:center; justify-content:center;
        background:#eef3ff; color:#2f5bd3; font-weight:800; border:1px solid #dfe8ff;
        }
        .flow-card .flow-title{ font-weight:700; color:#1f2d3d; }
        .flow-card .flow-sub{ color:#6b7785; font-size:13px; margin-top:2px; }
    
        /* === [자동차 사고 보상상식] Floating button === */
        #claim-knowledge-fab{
        position: fixed;
        right: 20px;
        top: calc(50% - 230px);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        padding: 0 14px;
        border-radius: 12px;
        background: #2f5bd3;
        color: #fff;
        border: 1px solid #2147a8;
        box-shadow: 0 8px 18px rgba(0,0,0,0.15);
        font-weight: 700;
        z-index: 1001;
        text-decoration: none;
        }

        /* === [자동차 사고 보상상식] Modal === */
        #claim-knowledge-modal[hidden]{ display: none; }
        #claim-knowledge-modal { position: fixed; inset: 0; z-index: 1002; }
        #claim-knowledge-modal .ckm-backdrop{
        position: absolute; inset: 0; background: rgba(0,0,0,0.45);
        }
        #claim-knowledge-modal .ckm-dialog {
        position: fixed; /* fixed로 화면 기준 고정 */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: min(960px, calc(100vw - 64px));
        height: min(620px, calc(100vh - 200px));
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 12px 28px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        }

        /* Header */
        .ckm-header{ display:flex; align-items:center; justify-content:space-between;
        padding: 14px 16px; border-bottom: 1px solid #e8ebf0; background:#f9fbff; }
        .ckm-title-wrap{ line-height: 1.2; }
        .ckm-subtitle{ font-size: 13px; color:#6b7785; }
        .ckm-title{ margin: 2px 0 0; font-size: 20px; color:#12264b; }
        .ckm-close{ background:transparent; border:none; font-size: 28px; line-height:1; color:#6b7785; cursor:pointer; }

        /* Tabs */
        .ckm-tabs{ display:flex; gap:8px; padding: 10px 12px; border-bottom: 1px solid #eef2f7; }
        .ckm-tab{ padding: 8px 12px; border-radius: 10px; border:1px solid #dfe6f2; background:#fff; cursor:pointer; }
        .ckm-tab[aria-selected="true"]{ background:#eef3ff; color:#2f5bd3; border-color:#cfe0ff; font-weight:700; }

        /* Body layout */
        .ckm-body{ display:grid; grid-template-columns: 42% 58%; gap:0; height:100%; min-height:0; }
        .ckm-list{ border-right:1px solid #eef2f7; overflow:auto; padding: 10px; }
        .ckm-detail{ overflow:auto; padding: 14px 16px; }
        .ckm-empty{ color:#8a95a3; font-size:14px; margin-top: 12px; }

        /* List items */
        .ckm-item{ border:1px solid #e6ebf3; border-radius:12px; padding:10px 12px; margin: 8px 0; background:#fff; cursor:pointer; }
        .ckm-item:hover{ border-color:#cfd9ee; background:#fbfcff; }
        .ckm-item .num{ font-weight:800; color:#2f5bd3; margin-right:8px; }
        .ckm-item .title{ font-weight:700; color:#1b2a4a; }

        /* Detail */
        .ckm-detail .d-title{ font-size:18px; font-weight:800; color:#12264b; margin-bottom:8px; }
        .ckm-detail .d-body{ white-space:pre-wrap; line-height:1.6; color:#2a364d; }

</style>
</head>
<body>
    {% load static %}
    <div class="container">
        <div class="header">
            <h1>보험 약관 AI 검색</h1>
            <p>궁금한 보험 내용을 자연어로 질문해보세요.</p>
            {% if user.is_authenticated %}
            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="nav-btn logout-btn">로그아웃</button>
            </form>
            {% endif %}

            <div style="margin-top: 16px;">
                <a href="{% url 'home' %}" class="nav-btn">홈으로</a>
                <a href="{% url 'recommend_insurance' %}" class="nav-btn">보험료 계산</a>
            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="예: 음주운전으로 사고가 났을 때 보험금을 받을 수 있나요?"
                    onkeypress="handleKeyPress(event)"
                >
                <button id="searchBtn" class="search-btn" onclick="searchClauses()">검색</button>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                AI가 관련 약관을 찾고 있습니다...
            </div>

            <div id="results" class="results">
                <h3>검색 결과</h3>
                <div id="resultsList"></div>
            </div>

            <div class="example-queries">
                <h3>예시 질문</h3>
                <div class="example-query" onclick="setQuery('음주운전으로 사고가 났을 때 보험금을 받을 수 있나요?')">음주운전 사고 시 보험 적용 여부</div>
                <div class="example-query" onclick="setQuery('무사고 할인 혜택이 있나요?')">무사고 할인 혜택</div>
                <div class="example-query" onclick="setQuery('의료비는 어떻게 보장되나요?')">의료비 보장 범위</div>
                <div class="example-query" onclick="setQuery('면책사항에는 어떤 것들이 있나요?')">면책사항 조회</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>AI 기반 보험 약관 검색 시스템 | RAG + Pinecone + LLM</p>
    </div>

    
    <!-- [자동차 사고 보상상식] 플로팅 버튼 -->
    <a id="claim-knowledge-fab" href="javascript:void(0)" title="자동차 사고 보상상식">자동차 사고 보상상식</a>

    <!-- [자동차 사고 보상상식] 팝업 모달 -->
    <div id="claim-knowledge-modal" role="dialog" aria-modal="true" aria-labelledby="claim-knowledge-title" hidden>
    <div class="ckm-backdrop"></div>
    <div class="ckm-dialog" role="document">
        <div class="ckm-header">
        <div class="ckm-title-wrap">
            <div class="ckm-subtitle"><h4>사례로 알아보는</h4></div>
            <h1 id="claim-knowledge-title" class="ckm-title"><h2>자동차 사고 보상상식</h2></h1>
        </div>
        <button class="ckm-close" type="button" aria-label="닫기" title="닫기">&times;</button>
        </div>

        <div class="ckm-tabs" role="tablist" aria-label="분류 선택">
        <button class="ckm-tab" type="button" role="tab" data-cat="차 vs. 차" aria-selected="true">차 vs. 차</button>
        <button class="ckm-tab" type="button" role="tab" data-cat="차 vs. 사람" aria-selected="false">차 vs. 사람</button>
        <button class="ckm-tab" type="button" role="tab" data-cat="차 vs. 기타" aria-selected="false">차 vs. 기타</button>
        </div>

        <div class="ckm-body">
        <div class="ckm-list" id="ckm-list" aria-label="사례 목록" role="listbox"></div>
        <div class="ckm-detail" id="ckm-detail" aria-live="polite">
            <div class="ckm-empty">좌측에서 사례를 선택하세요.</div>
        </div>
        </div>
    </div>
    </div>

    <!-- 플로팅: 사고처리 가이드 / 주간 정보 -->
    <a id="guide-fab"  href="javascript:void(0)">사고처리 가이드</a>
    <a id="weekly-fab" href="/weekly/" target="_blank" rel="noopener">보험상식</a>

    <!-- 사고처리 가이드 모달 -->
    <div class="modal fade" id="guideModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">사고처리 가이드</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div id="guideBody">로딩 중...</div>
            </div>
            <div class="modal-footer">
                <small class="text-muted">안내 내용은 법적 효력이 없으며 실제 상황과 다를 수 있습니다.</small>
            </div>
            </div>
        </div>
    </div>

    <!-- 우측 하단 플로팅 챗봇 UI -->
    <div id="chatbot-fab" title="보험 약관 챗봇">챗봇</div>
    <div id="chatbot-container">
        <div id="chatbot-header">
            <span>보험 약관 상담</span>
            <button id="chatbot-close" style="background:transparent;border:none;color:#fff;">닫기</button>
        </div>
        <div id="chatbot-messages"></div>
        <div id="chatbot-input">
            <input id="chatbot-text" type="text" placeholder="사고 상황을 입력하세요. 예) 정차 중 뒤에서 박음" />
            <button id="chatbot-send">전송</button>
        </div>
    </div>

    <script>
        function handleKeyPress(event) {
            if (event.key === 'Enter') searchClauses();
        }
        function setQuery(query) {
            document.getElementById('searchInput').value = query;
            searchClauses();
        }
        async function searchClauses() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) { alert('검색어를 입력해주세요.'); return; }
            const searchBtn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            searchBtn.disabled = true; loading.style.display = 'block'; results.style.display = 'none';
            try {
                const response = await fetch('/insurance-recommendation/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json','X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify({ query })
                });
                const data = await response.json();
                if (data.success && data.results) displayResults(data.results);
                else displayNoResults();
            } catch (error) {
                console.error('검색 오류:', error);
                alert('검색 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                searchBtn.disabled = false; loading.style.display = 'none';
            }
        }
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            const resultsDiv = document.getElementById('results');
            if (results.length === 0) { displayNoResults(); return; }
            let html = '';
            results.forEach((result, index) => {
                const score = (result.score * 100).toFixed(1);
                html += `
                    <div class="result-item" style="animation-delay: ${index * 0.1}s">
                        <div class="result-header">
                            <div class="document-name">${result.document}</div>
                            <div class="similarity-score">유사도 ${score}%</div>
                        </div>
                        <div class="result-text">${result.text}</div>
                    </div>`;
            });
            resultsList.innerHTML = html; resultsDiv.style.display = 'block';
        }
        function displayNoResults() {
            const resultsList = document.getElementById('resultsList');
            const resultsDiv = document.getElementById('results');
            resultsList.innerHTML = `<div class="no-results"><h3>검색 결과가 없습니다</h3><p>다른 키워드로 다시 검색해보세요.</p></div>`;
            resultsDiv.style.display = 'block';
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                    }
                }
            }
            return cookieValue;
        }

        /* 플로팅 챗봇 최소 구현 (기존 로직 유지) */
        (function(){
            const fab = document.getElementById('chatbot-fab');
            const box = document.getElementById('chatbot-container');
            const closeBtn = document.getElementById('chatbot-close');
            const messagesEl = document.getElementById('chatbot-messages');
            const inputEl = document.getElementById('chatbot-text');
            const sendBtn = document.getElementById('chatbot-send');
            const headerEl = document.getElementById('chatbot-header');
            let isDragging = false, offsetX = 0, offsetY = 0, expanded = false;

            function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }
            function addMsg(role, html){ const div = document.createElement('div'); div.className = 'msg ' + (role === 'user' ? 'user' : 'bot'); div.innerHTML = html; messagesEl.appendChild(div); scrollBottom(); }
            fab.onclick = () => { box.style.display = 'flex'; };
            closeBtn.onclick = () => { box.style.display = 'none'; };
            function ask(){ const t=inputEl.value.trim(); if(!t) return; addMsg('user', t); inputEl.value=''; addMsg('bot','준비 중입니다.'); }
            sendBtn.onclick = ask; inputEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') ask(); });
            headerEl.addEventListener('mousedown', (e) => {
                isDragging = true; const rect = box.getBoundingClientRect();
                if (!box.style.left && !box.style.top) { box.style.left = rect.left + 'px'; box.style.top = rect.top + 'px'; box.style.right = ''; box.style.bottom = ''; }
                offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top; document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let x = e.clientX - offsetX, y = e.clientY - offsetY;
                const maxX = window.innerWidth - box.offsetWidth, maxY = window.innerHeight - box.offsetHeight;
                if (x < 0) x = 0; if (y < 0) y = 0; if (x > maxX) x = maxX; if (y > maxY) y = maxY;
                box.style.left = x + 'px'; box.style.top = y + 'px';
            });
            document.addEventListener('mouseup', () => { if (isDragging) { document.body.style.userSelect = ''; } isDragging = false; });
            addMsg('bot','사고 상황을 입력하면 필요한 정보를 단계적으로 물어보고 안내합니다.');
        })();

        /* ======= 사고처리 가이드 JSON 경로 ======= */
        const PATH_ACCIDENT = '/static/json/사고처리.json';
        const PATH_EVIDENCE = '/static/json/증거확보.json';
        const PATH_VARIANTS = '/static/json/다양한처리.json';
        async function loadJSON(url){ const res = await fetch(url); if(!res.ok) throw new Error('fetch error: ' + url); return await res.json(); }

        /* 렌더링 유틸 */
        const ul = arr => `<ul class="mb-2">${(arr||[]).map(t=>`<li>${t}</li>`).join('')}</ul>`;
        const badge = (txt, cls='bg-secondary') => `<span class="badge ${cls} me-2">${txt}</span>`;

        /* 기본 블록형(하단 흐름용) */
        function renderStep(step){
            return `
            <div class="border rounded p-3 mb-3">
                <div class="d-flex align-items-center mb-1">
                    ${badge(step.step || '', 'bg-primary')}
                    <strong>${step.title || ''}</strong>
                </div>
                ${step.subtitle ? `<div class="text-muted mb-2">${step.subtitle}</div>` : ''}
                ${step.details && step.details.length ? ul(step.details) : ''}
                ${step._extraButtons || ''}
                ${step._extraContent || ''}
            </div>`;
        }
        function renderSectionTitle(title){ return `<h6 class="mt-4 mb-2">${title}</h6>`; }

        /* 단계별 이미지 매핑 */
        const STEP_IMG = {
            '01': "{% static 'img/image1.png' %}",
            '02': "{% static 'img/image2.png' %}",
            '03': "{% static 'img/image3.png' %}",
            '04': "{% static 'img/image4.png' %}",
            '05': "{% static 'img/image5.png' %}",
            '06': "{% static 'img/image6.png' %}",
        };
        const getStepImg = (n) => STEP_IMG[String(n).padStart(2,'0')] || null;

        /* 카드형 렌더러(메인 01~06 단계) */
        function renderStepCard(step) {
            const stepNo = step.step || '';
            const title  = step.title || '';
            const subtitle = step.subtitle ? `<div class="subtitle">${step.subtitle}</div>` : '';
            const details  = (step.details && step.details.length) ? ul(step.details) : '';
            const buttons  = step._extraButtons || '';
            const extra    = step._extraContent || '';
            const imgSrc   = getStepImg(stepNo);
            const imgBlock = imgSrc ? `<div class="thumb"><img src="${imgSrc}" alt="${title}"></div>` : '';
            return `
                <div class="guide-card">
                    ${imgBlock}
                    <div class="head">
                        <div class="step-badge">${stepNo}</div>
                        <div class="title">${title}</div>
                    </div>
                    ${subtitle}
                    ${details}
                    ${buttons ? `<div class="btn-toggle">${buttons}</div>` : ''}
                    ${extra}
                </div>`;
        }

        /* 병합 로직 */
        function mergeGuide(baseSteps, evidence, variants){
            const target1 = baseSteps.find(s => (s.title||'').includes('사고현장보존'));
            if(target1 && evidence?.items?.length){
                target1.details = (target1.details || []).concat(['[증거확보 체크리스트]']).concat(evidence.items);
            }
            const policeStep = baseSteps.find(s => (s.title||'').includes('경찰서'));
            if(policeStep && variants?.섹션?.length){
                const policeHtml = variants.섹션.map(sec => `
                    <div class="border rounded p-2 mb-2">
                        <div class="fw-semibold mb-1">${sec.제목}</div>
                        ${(sec.절차||[]).map(p=>`
                            <div class="ms-2">
                                ${badge(p.step,'bg-info')} <strong>${p.title}</strong>
                                ${p.details && p.details.length ? ul(p.details) : ''}
                                ${p["비고"] && p["비고"].length ? `<div class="small text-muted">비고: ${p["비고"].join(', ')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>`).join('');
                const areaId = 'police-extra-' + Date.now();
                policeStep._extraButtons = `
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">
                        경찰서 절차 상세 열기/닫기
                    </button>`;
                policeStep._extraContent = `<div id="${areaId}" class="collapse mt-2">${policeHtml}</div>`;
            }
            const insurerStep = baseSteps.find(s => (s.title||'').includes('보험사'));
            if(insurerStep && variants?.보험회사?.절차?.length){
                const insHtml = (variants.보험회사.절차||[]).map(p=>`
                    <div class="ms-2">
                        ${badge(p.step,'bg-warning')} <strong>${p.title}</strong>
                        ${p.details && p.details.length ? ul(p.details) : ''}
                    </div>`).join('');
                const areaId = 'ins-extra-' + Date.now();
                insurerStep._extraButtons = `
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">
                        보험사 절차 상세 열기/닫기
                    </button>`;
                insurerStep._extraContent = `<div id="${areaId}" class="collapse mt-2">${insHtml}</div>`;
            }
            return baseSteps;
        }

        function appendVictimAndProperty(variants){
        let html = '';

        // 내부 step을 카드형으로 감싸서 그려주는 헬퍼
        const renderFlowList = (steps) => {
            return `<div class="flow-list">` + steps.map(s => {
            const subtitle = s.subtitle ? `<div class="flow-sub">${s.subtitle}</div>` : '';
            const details  = (s.details && s.details.length)
                ? `<ul class="mb-2">${s.details.map(t=>`<li>${t}</li>`).join('')}</ul>` : '';
            return `
                <div class="flow-card">
                <div class="flow-head">
                    <div class="flow-badge">${s.step || ''}</div>
                    <div>
                    <div class="flow-title">${s.title || ''}</div>
                    ${subtitle}
                    </div>
                </div>
                ${details}
                ${s._extraButtons || ''}
                ${s._extraContent || ''}
                </div>
            `;
            }).join('') + `</div>`;
        };

        if(variants?.피해물?.절차?.length){
            const areaId = 'victim-car-' + Date.now();
            html += `
            <div class="flow-section">
                <h6 class="mb-2">피해물(차량) 처리 흐름</h6>
                <button class="flow-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">
                내용 열기/닫기
                </button>
                <div id="${areaId}" class="collapse">
                ${renderFlowList(variants.피해물.절차)}
                </div>
            </div>
            `;
        }

        if(variants?.피해자?.절차?.length){
            const areaId = 'victim-human-' + Date.now();
            html += `
            <div class="flow-section">
                <h6 class="mb-2">피해자 처리 흐름</h6>
                <button class="flow-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">
                내용 열기/닫기
                </button>
                <div id="${areaId}" class="collapse">
                ${renderFlowList(variants.피해자.절차)}
                </div>
            </div>
            `;
        }

        return html;
        }

        async function openGuide(){
            try{
                const [base, evidence, variants] = await Promise.all([
                    loadJSON(PATH_ACCIDENT),
                    loadJSON(PATH_EVIDENCE),
                    loadJSON(PATH_VARIANTS)
                ]);
                const merged = mergeGuide([...base], evidence, variants);

                const body = document.getElementById('guideBody');
                let html = '';
                html += `<div class="alert alert-info py-2 mb-3">기본 사고 처리 순서와 기관·보험사별 절차 요약입니다.</div>`;

                /* 메인 단계: 카드형 2줄 그리드 + 가로 스크롤 */
                html += `<div class="guide-grid">` + merged.map(renderStepCard).join('') + `</div>`;

                /* 하단 흐름(피해물/피해자): 기존 블록형 */
                html += appendVictimAndProperty(variants);

                body.innerHTML = html;

                const modal = new bootstrap.Modal(document.getElementById('guideModal'));
                modal.show();
            }catch(e){
                document.getElementById('guideBody').innerHTML = `<div class="text-danger">가이드를 불러오지 못했습니다: ${e}</div>`;
                const modal = new bootstrap.Modal(document.getElementById('guideModal'));
                modal.show();
            }
        }
        document.getElementById('guide-fab')?.addEventListener('click', openGuide);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        (function(){
        // 정적 파일 경로: 서버의 정적 경로로 교체하세요.
        // Django 사용 시: {% load static %} 후 -> const DATA_URL = "{% static 'json/merged_cases.jsonl' %}";
        const DATA_URL = "/static/json/merged_cases.jsonl";

        const fab = document.getElementById('claim-knowledge-fab');
        const modal = document.getElementById('claim-knowledge-modal');
        const backdrop = modal?.querySelector('.ckm-backdrop');
        const closeBtn = modal?.querySelector('.ckm-close');
        const tabs = modal?.querySelectorAll('.ckm-tab');
        const listEl = document.getElementById('ckm-list');
        const detailEl = document.getElementById('ckm-detail');

        let byCat = {};

        function openModal(){ modal.removeAttribute('hidden'); }
        function closeModal(){ modal.setAttribute('hidden',''); }

        function parseJSONL(text){
            return text.split('\n').map(s=>s.trim()).filter(Boolean).map(line=>{
            try { return JSON.parse(line); } catch(e){ return null; }
            }).filter(Boolean);
        }

        function normalizeCategory(raw){
            if(!raw) return '';
            const s = String(raw).trim();
            if(s.includes('차 vs. 차')) return '차 vs. 차';
            if(s.includes('차 vs. 사람') || s.includes('차 vs. 보행자')) return '차 vs. 사람';
            if(s.includes('차 vs. 기타') || s.includes('차 vs. 자전거') || s.includes('차 vs. 이륜')) return '차 vs. 기타';
            return s;
        }

        function groupByCategory(data){
            const m = {'차 vs. 차':[], '차 vs. 사람':[], '차 vs. 기타':[]};
            data.forEach(it=>{
            const cat = normalizeCategory(it.category);
            const row = {
                category: cat || '',
                num: (it.num || '').trim(),
                title: (it.title || '').trim(),
                body: (it.body || '').trim()
            };
            if(!m[cat]) m[cat] = [];
            m[cat].push(row);
            });
            for(const k in m){
            m[k].sort((a,b)=>{
                const na = parseInt((a.num||'').replace(/\D/g,'')) || 9999;
                const nb = parseInt((b.num||'').replace(/\D/g,'')) || 9999;
                if(na !== nb) return na - nb;
                return (a.title||'').localeCompare(b.title||'', 'ko');
            });
            }
            return m;
        }

        function renderList(category){
            listEl.innerHTML = '';
            const arr = byCat[category] || [];
            if(arr.length === 0){
            listEl.innerHTML = '<div class="ckm-empty">해당 분류의 사례가 없습니다.</div>';
            detailEl.innerHTML = '<div class="ckm-empty">좌측에서 사례를 선택하세요.</div>';
            return;
            }
            arr.forEach((item, idx)=>{
            const el = document.createElement('div');
            el.className = 'ckm-item';
            el.setAttribute('role','option');
            el.setAttribute('tabindex','0');
            el.dataset.index = idx;
            let displayNum;
            if (item.num && item.num.trim()) {
            displayNum = item.num.trim();
            } else {
            // idx+1을 2자리로 포맷
            displayNum = String(idx + 1).padStart(2, '0') + '.';
            }
            el.innerHTML = '<span class="num">' + displayNum + '</span>' +
                        '<span class="title">' + (item.title || '(제목 없음)') + '</span>';
            el.addEventListener('click', ()=> renderDetail(category, idx));
            el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') renderDetail(category, idx); });
            listEl.appendChild(el);
            });
            renderDetail(category, 0);
        }

        function renderDetail(category, index){
            const arr = byCat[category] || [];
            const item = arr[index];
            if(!item){
            detailEl.innerHTML = '<div class="ckm-empty">좌측에서 사례를 선택하세요.</div>';
            return;
            }
            const body = (item.body || '').replace(/\n{3,}/g, '\n\n');
            detailEl.innerHTML = '<div class="d-title">'+(item.title || '(제목 없음)')+'</div>' +
                                '<div class="d-body">'+body+'</div>';
        }

        function selectTab(btn){
            tabs.forEach(t => t.setAttribute('aria-selected', t===btn ? 'true':'false'));
            const cat = btn.dataset.cat;
            renderList(cat);
        }

        fab?.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);
        backdrop?.addEventListener('click', closeModal);
        tabs?.forEach(t => t.addEventListener('click', ()=> selectTab(t)));

        // 데이터 로드
        fetch(DATA_URL, {cache:'no-store'})
            .then(res => { if(!res.ok) throw new Error('데이터 로드 실패'); return res.text(); })
            .then(text => {
            const all = parseJSONL(text);
            byCat = groupByCategory(all);
            const firstSelected = Array.from(tabs).find(b => b.getAttribute('aria-selected') === 'true') || tabs[0];
            if(firstSelected) selectTab(firstSelected);
            })
            .catch(err => {
            console.error(err);
            listEl.innerHTML = '<div class="ckm-empty">데이터를 불러오지 못했습니다.</div>';
            });
        })();
    </script>

</body>
</html>
