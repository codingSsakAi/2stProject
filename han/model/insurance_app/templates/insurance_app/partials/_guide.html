<!-- 사고처리 가이드: 플로팅 버튼 -->
<style>
  #guide-fab{
    position:fixed; right:20px; top:calc(50% - 160px);
    height:40px; padding:0 14px; border-radius:20px; font-weight:700;
    display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:9998;
    text-decoration:none; background:#fff; color:#7e57c2; border:2px solid #7e57c2;
    box-shadow:0 8px 20px rgba(0,0,0,.12);
  }
  #guide-fab:hover{ background:#7e57c2; color:#fff; }

  /* 모달 내부 스크롤/그리드/카드 */
  #guideModal .modal-body{ max-height:70vh; overflow:auto; }
  .guide-grid{ display:grid; grid-template-rows:repeat(2,1fr); gap:16px 20px; padding:8px 6px 12px; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; }
  .guide-grid>.guide-card{ scroll-snap-align:start; background:#fff; border:1px solid #e8ebf0; border-radius:14px; padding:18px 16px; box-shadow:0 8px 18px rgba(0,0,0,.05); min-width:300px; }
  .guide-card .head{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .guide-card .step-badge{ width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#eef3ff; color:#2f5bd3; font-weight:800; border:1px solid #dfe8ff; }
  .guide-card .title{ font-weight:700; color:#1f2d3d; }
  .guide-card .subtitle{ color:#6b7785; font-size:13px; margin:6px 0 4px; }
  .guide-card ul{ margin:8px 0 0; padding-left:18px; color:#2c3e50; }
  .guide-card li{ margin:3px 0; font-size:14px; line-height:1.5; }
  .guide-card .btn-toggle{ margin-top:10px; }
</style>

<a id="guide-fab" href="javascript:void(0)">사고처리 가이드</a>

<!-- 사고처리 가이드 모달 -->
<div class="modal fade" id="guideModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">사고처리 가이드</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body"><div id="guideBody">로딩 중...</div></div>
      <div class="modal-footer"><small class="text-muted">안내는 참고용입니다.</small></div>
    </div>
  </div>
</div>

<script>
/* ---- 데이터 경로 ---- */
const PATH_ACCIDENT = '/static/json/사고처리.json';
const PATH_EVIDENCE = '/static/json/증거확보.json';
const PATH_VARIANTS = '/static/json/다양한처리.json';

/* ---- 유틸 ---- */
async function loadJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(url); return r.json(); }
const ul = arr => `<ul class="mb-2">${(arr||[]).map(t=>`<li>${t}</li>`).join('')}</ul>`;
const badge = (txt, cls='bg-secondary') => `<span class="badge ${cls} me-2">${txt}</span>`;

/* ---- 카드/스텝 렌더 ---- */
function renderStep(step){
  return `<div class="border rounded p-3 mb-3">
    <div class="d-flex align-items-center mb-1">${badge(step.step||'','bg-primary')}<strong>${step.title||''}</strong></div>
    ${step.subtitle?`<div class="text-muted mb-2">${step.subtitle}</div>`:''}
    ${step.details?.length?ul(step.details):''}
    ${step._extraButtons||''}
    ${step._extraContent||''}
  </div>`;
}
function renderStepCard(step){
  const details = step.details?.length ? ul(step.details) : '';
  return `<div class="guide-card">
    <div class="head"><div class="step-badge">${step.step||''}</div><div class="title">${step.title||''}</div></div>
    ${step.subtitle?`<div class="subtitle">${step.subtitle}</div>`:''}
    ${details}
    ${step._extraButtons?`<div class="btn-toggle">${step._extraButtons}</div>`:''}
    ${step._extraContent||''}
  </div>`;
}
function renderSectionTitle(t){ return `<h6 class="mt-4 mb-2">${t}</h6>`; }

/* ---- 피해물/피해자 접힘 섹션 ---- */
function renderFlowSection(title, steps, idSeed, cls){
  const id = `${idSeed}-${Date.now()}`;
  return `
  <div class="mt-3">
    <div class="d-flex align-items-center justify-content-between p-2 rounded ${cls}">
      <div class="fw-bold">${title}</div>
      <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${id}">자세히</button>
    </div>
    <div id="${id}" class="collapse mt-2"><div class="border rounded p-2 bg-white">${(steps||[]).map(renderStep).join('')}</div></div>
  </div>`;
}
function appendVictimAndProperty(variants){
  let html='';
  if(variants?.피해물?.절차?.length) html += renderFlowSection('피해물(차량) 처리 흐름', variants.피해물.절차, 'flow-prop', 'bg-light border');
  if(variants?.피해자?.절차?.length) html += renderFlowSection('피해자 처리 흐름', variants.피해자.절차, 'flow-victim', 'bg-light border');
  return html;
}

/* ---- 병합: 증거확보/경찰/보험사 버튼내용 추가 ---- */
function mergeGuide(baseSteps, evidence, variants){
  const target1 = baseSteps.find(s => (s.title||'').includes('사고현장보존'));
  if(target1 && evidence?.items?.length){
    target1.details = (target1.details||[]).concat(['[증거확보 체크리스트]']).concat(evidence.items);
  }
  const policeStep = baseSteps.find(s => (s.title||'').includes('경찰서'));
  if(policeStep && variants?.섹션?.length){
    const policeHtml = variants.섹션.map(sec => `
      <div class="border rounded p-2 mb-2">
        <div class="fw-semibold mb-1">${sec.제목}</div>
        ${(sec.절차||[]).map(p=>`
          <div class="ms-2">
            ${badge(p.step,'bg-info')} <strong>${p.title}</strong>
            ${p.details?.length?ul(p.details):''}
            ${p["비고"]?.length?`<div class="small text-muted">비고: ${p["비고"].join(', ')}</div>`:''}
          </div>
        `).join('')}
      </div>`).join('');
    const areaId = 'police-extra-' + Date.now();
    policeStep._extraButtons = `<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">경찰서 절차 상세 열기/닫기</button>`;
    policeStep._extraContent = `<div id="${areaId}" class="collapse mt-2">${policeHtml}</div>`;
  }
  const insurerStep = baseSteps.find(s => (s.title||'').includes('보험사'));
  if(insurerStep && variants?.보험회사?.절차?.length){
    const insHtml = variants.보험회사.절차.map(p=>`
      <div class="ms-2">
        ${badge(p.step,'bg-warning')} <strong>${p.title}</strong>
        ${p.details?.length?ul(p.details):''}
      </div>`).join('');
    const areaId = 'ins-extra-' + Date.now();
    insurerStep._extraButtons = `<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${areaId}">보험사 절차 상세 열기/닫기</button>`;
    insurerStep._extraContent = `<div id="${areaId}" class="collapse mt-2">${insHtml}</div>`;
  }
  return baseSteps;
}

/* ---- 2줄(1~3 / 4~6) 보장 렌더 ---- */
function renderTwoRows(steps){
  const n=steps.length; const topCount = (n===6)?3:Math.ceil(n/2);
  const top = steps.slice(0, topCount), bottom = steps.slice(topCount);
  return `<div class="guide-grid">${top.map(renderStepCard).join('')}${bottom.map(renderStepCard).join('')}</div>`;
}

/* ---- 오픈 핸들러 ---- */
async function openGuide(){
  try{
    const [base, evidence, variants] = await Promise.all([loadJSON(PATH_ACCIDENT), loadJSON(PATH_EVIDENCE), loadJSON(PATH_VARIANTS)]);
    const merged = mergeGuide([...base], evidence, variants);
    const body = document.getElementById('guideBody');
    let html = `<div class="alert alert-info py-2 mb-3">기본 사고 처리 순서와 기관·보험사별 절차 요약입니다.</div>`;
    html += renderTwoRows(merged);
    html += appendVictimAndProperty(variants);
    body.innerHTML = html;
  }catch(e){
    document.getElementById('guideBody').innerHTML = `<div class="text-danger">가이드를 불러오지 못했습니다: ${e}</div>`;
  }
  new bootstrap.Modal(document.getElementById('guideModal')).show();
}
document.getElementById('guide-fab')?.addEventListener('click', openGuide);
</script>
