{% extends 'base/base.jinja.html' %}
{% load markdown_extras %}

{% block title %}{{ title }} - ìë™ì°¨ ë³´í—˜ ì¶”ì²œ ì±—ë´‡{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-robot text-primary"></i>
        ìë™ì°¨ ë³´í—˜ ìƒë‹´ ì±—ë´‡
      </h2>

      <!-- ì±—ë´‡ ì„¤ëª… -->
      <div class="alert alert-info">
        <h5>
          <i class="fas fa-info-circle"></i>
          ì±—ë´‡ ì‚¬ìš©ë²•
        </h5>
        <p class="mb-0">
          ìë™ì°¨ ë³´í—˜ì— ëŒ€í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹œë©´, ì—…ë¡œë“œëœ ë³´í—˜ ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤. ë³´í—˜ ê°€ì…, ë³´ì¥
          ë²”ìœ„, í• ì¸ í˜œíƒ ë“± ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”.
        </p>
      </div>

      <!-- ì‹¤ì‹œê°„ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-comments"></i>
            ì‹¤ì‹œê°„ ì±„íŒ…
          </h5>
        </div>
        <div class="card-body">
          <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
          <div id="chat-messages" class="chat-messages-container mb-3">
            {% if latest_chat_history %}
              {% for message in latest_chat_history %}
                <div class="chat-message mb-3 {% if message.is_user %}user-message{% else %}bot-message{% endif %}">
                  <div class="d-flex {% if message.is_user %}justify-content-end{% endif %}">
                    <div class="chat-bubble {% if message.is_user %}user-bubble{% else %}bot-bubble{% endif %}">
                      <div class="message-header mb-2">
                        <span class="badge {% if message.is_user %}bg-primary{% else %}bg-success{% endif %}">
                          {% if message.is_user %}
                            <i class="fas fa-user"></i>
                            ì‚¬ìš©ì
                          {% else %}
                            <i class="fas fa-robot"></i>
                            ì±—ë´‡
                          {% endif %}
                        </span>
                        <small class="text-muted ms-2">{{ message.created_at|date:"H:i" }}</small>
                      </div>

                      <div class="message-content">{{ message.message|format_chat_message }}</div>

                      {% if not message.is_user and message.metadata %}
                        <div class="message-metadata mt-2">
                          <details>
                            <summary class="text-muted small">
                              <i class="fas fa-info-circle"></i>
                              ë‹µë³€ ì •ë³´
                            </summary>
                            <div class="mt-2 p-2 bg-light rounded">
                              <small>
                                <strong>ì‚¬ìš©ëœ ë¬¸ì„œ:</strong>
                                {{ message.metadata.relevant_chunks_count }}ê°œ
                                <br />
                                <strong>ëª¨ë¸:</strong>
                                {{ message.metadata.model_used }}
                                <br />
                                <strong>ìƒì„± ì‹œê°„:</strong>
                                {{ message.metadata.formatted_time|default:"ì‹œê°„ ì •ë³´ ì—†ìŒ" }}
                              </small>
                            </div>
                          </details>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h5>
                <p class="text-muted">ì•„ë˜ ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  ì²« ë²ˆì§¸ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
              </div>
            {% endif %}
          </div>

          <!-- ë³´í—˜ ì¶”ì²œ í”„ë¡œí•„ ì…ë ¥ ë§í’ì„  -->
          <div id="profile-input-bubble" class="profile-input-bubble" style="display: none;">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="fas fa-user-edit"></i>
                  ë³´í—˜ ì¶”ì²œ ì •ë³´ ì…ë ¥
                </h6>
              </div>
              <div class="card-body">
                <form id="profile-form">
                  {% csrf_token %}
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="birth_date" class="form-label">ìƒë…„ì›”ì¼ *</label>
                      <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="gender" class="form-label">ì„±ë³„ *</label>
                      <select class="form-control" id="gender" name="gender" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="M">ë‚¨ì„±</option>
                        <option value="F">ì—¬ì„±</option>
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="residence_area" class="form-label">ê±°ì£¼ ì§€ì—­ *</label>
                      <select class="form-control" id="residence_area" name="residence_area" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì„œìš¸">ì„œìš¸</option>
                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                        <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="driving_experience" class="form-label">ìš´ì „ ê²½ë ¥ (ë…„) *</label>
                      <input type="number" class="form-control" id="driving_experience" name="driving_experience" min="0" max="50" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="car_type" class="form-label">ì°¨ì¢… *</label>
                      <select class="form-control" id="car_type" name="car_type" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ê²½ì°¨">ê²½ì°¨</option>
                        <option value="ì†Œí˜•">ì†Œí˜•</option>
                        <option value="ì¤€ì¤‘í˜•">ì¤€ì¤‘í˜•</option>
                        <option value="ì¤‘í˜•">ì¤‘í˜•</option>
                        <option value="ëŒ€í˜•">ëŒ€í˜•</option>
                        <option value="SUV">SUV</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="annual_mileage" class="form-label">ì—°ê°„ ì£¼í–‰ê±°ë¦¬ (km) *</label>
                      <input type="number" class="form-control" id="annual_mileage" name="annual_mileage" min="1000" max="100000" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="accident_history" class="form-label">ì‚¬ê³  ê²½ë ¥ (íšŸìˆ˜) *</label>
                      <input type="number" class="form-control" id="accident_history" name="accident_history" min="0" max="10" value="0" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="coverage_level" class="form-label">ë³´ì¥ ìˆ˜ì¤€ *</label>
                      <select class="form-control" id="coverage_level" name="coverage_level" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ê¸°ë³¸">ê¸°ë³¸</option>
                        <option value="í‘œì¤€" selected>í‘œì¤€</option>
                        <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                        <option value="í”„ë¦¬ë¯¸ì—„">í”„ë¦¬ë¯¸ì—„</option>
                      </select>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="additional_coverage_interest" name="additional_coverage_interest">
                      <label class="form-check-label" for="additional_coverage_interest">
                        ì¶”ê°€ íŠ¹ì•½ì— ê´€ì‹¬ì´ ìˆë‚˜ìš”?
                      </label>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" onclick="hideProfileInput()">
                      <i class="fas fa-times"></i>
                      ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-check"></i>
                      ì •ë³´ ì €ì¥ ë° ì¶”ì²œ ë°›ê¸°
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- ì§ˆë¬¸ ì…ë ¥ í¼ -->
          <form id="chat-form">
            {% csrf_token %}
            <div class="input-group">
              <textarea
                class="form-control"
                id="message"
                name="message"
                rows="3"
                placeholder="ìë™ì°¨ ë³´í—˜ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”..."
                required
              ></textarea>
              <button class="btn btn-primary" type="submit" id="send-button">
                <i class="fas fa-paper-plane"></i>
                ì „ì†¡
              </button>
            </div>
          </form>

          <!-- ìë™ì™„ì„± ì œì•ˆ -->
          <div class="mt-3">
            <small class="text-muted">
              <i class="fas fa-lightbulb"></i>
              ì¶”ì²œ ì§ˆë¬¸:
            </small>
            <div class="mt-2">
              <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="setMessage('ìë™ì°¨ë³´í—˜ ì¶”ì²œí•´ì£¼ì„¸ìš”')">
                ìë™ì°¨ë³´í—˜ ì¶”ì²œí•´ì£¼ì„¸ìš”
              </button>
              <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="setMessage('ë³´í—˜ê¸ˆ ì²­êµ¬ ì ˆì°¨ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')">
                ë³´í—˜ê¸ˆ ì²­êµ¬ ì ˆì°¨
              </button>
              <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="setMessage('ê° ë³´í—˜ì‚¬ì˜ ì—°ë½ì²˜ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”')">
                ë³´í—˜ì‚¬ ì—°ë½ì²˜
              </button>
              <button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="setMessage('ë¬´ë³´í—˜ìë™ì°¨ ì‚¬ê³ ì‹œ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?')">
                ë¬´ë³´í—˜ìë™ì°¨ ì‚¬ê³ 
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì±„íŒ… ì„¸ì…˜ ëª©ë¡ -->
      {% if chat_sessions %}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-history"></i>
              ì´ì „ ëŒ€í™” ê¸°ë¡
            </h5>
          </div>
          <div class="card-body">
            <div class="list-group">
              {% for session in chat_sessions %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">
                      <a href="{% url 'chatbot:chat_session' session.id %}" class="text-decoration-none">
                        {{ session.title }}
                      </a>
                    </h6>
                    <small class="text-muted">
                      <i class="fas fa-clock"></i>
                      {{ session.updated_at|date:"Y-m-d H:i" }}
                    </small>
                  </div>
                  <div>
                    <a href="{% url 'chatbot:chat_session' session.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-eye"></i>
                      ë³´ê¸°
                    </a>
                    <a href="{% url 'chatbot:chat_delete' session.id %}" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i>
                      ì‚­ì œ
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% else %}
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="fas fa-comments fa-4x text-muted mb-4"></i>
            <h5 class="text-muted">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h5>
            <p class="text-muted">ìœ„ì˜ ì§ˆë¬¸ ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  ì²« ë²ˆì§¸ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .chat-messages-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 15px;
    background-color: #f8f9fa;
  }

  .chat-bubble {
    max-width: 80%;
    padding: 15px;
    border-radius: 15px;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .user-bubble {
    background-color: #007bff;
    color: white;
  }

  .bot-bubble {
    background-color: white;
    color: #212529;
    border: 1px solid #dee2e6;
  }

  .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }

  .message-content {
    line-height: 1.5;
  }

  .message-metadata summary {
    cursor: pointer;
    user-select: none;
  }

  .message-metadata summary:hover {
    color: #6c757d;
  }

  .input-group textarea {
    resize: none;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }

  .input-group .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }

  /* ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
  .auto-complete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .auto-complete-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s;
  }

  .auto-complete-item:hover,
  .auto-complete-item.selected {
    background-color: #f8f9fa;
  }

  .auto-complete-item:last-child {
    border-bottom: none;
  }

  /* ë°°ì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
  .contact-info-badge .badge,
  .cache-badge .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .contact-info-badge .badge {
    background-color: #17a2b8 !important;
  }

  .cache-badge .badge {
    background-color: #6c757d !important;
  }

  /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
  .markdown-bold {
    font-weight: bold;
    color: #2c3e50;
  }

  .markdown-italic {
    font-style: italic;
    color: #34495e;
  }

  .markdown-code {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #e74c3c;
  }

  .markdown-heading {
    color: #2c3e50;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .markdown-paragraph {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  .markdown-list {
    margin-left: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .markdown-list-item {
    margin-bottom: 0.25rem;
  }

  .highlight-keyword {
    background-color: #fff3cd;
    color: #856404;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
  }

  /* ë³´í—˜ ì¶”ì²œ í”„ë¡œí•„ ì…ë ¥ ë§í’ì„  ìŠ¤íƒ€ì¼ */
  .profile-input-bubble {
    margin-bottom: 20px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .profile-input-bubble .card {
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
  }

  .profile-input-bubble .card-header {
    border-radius: 15px 15px 0 0 !important;
  }

  .profile-input-bubble .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .profile-input-bubble .btn {
    border-radius: 8px;
    font-weight: 500;
  }

  .profile-input-bubble .btn-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
  }

  .profile-input-bubble .btn-primary:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // CSRF í† í°ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
  let csrfToken = '';
  
  // CSRF í† í° ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeCSRFToken() {
    // Djangoì˜ getCookie í•¨ìˆ˜
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // ë¨¼ì € hidden inputì—ì„œ ì‹œë„
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token && token.value) {
      csrfToken = token.value;
      
      return;
    }
    
    // ì¿ í‚¤ì—ì„œ ì‹œë„
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) {
      csrfToken = csrftoken;
      
      return;
    }
    
    console.warn('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  document.addEventListener('DOMContentLoaded', function () {
    // CSRF í† í° ì´ˆê¸°í™”
    initializeCSRFToken();
    // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function markdownToHtml(text) {
      if (!text) return '';

      // **í…ìŠ¤íŠ¸** -> <strong>í…ìŠ¤íŠ¸</strong>
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

      // *í…ìŠ¤íŠ¸* -> <em>í…ìŠ¤íŠ¸</em>
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

      // `í…ìŠ¤íŠ¸` -> <code>í…ìŠ¤íŠ¸</code>
      text = text.replace(/`(.*?)`/g, '<code class="markdown-code">$1</code>');

      // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
      text = text.replace(/\n/g, '<br>');

      return text;
    }

    // ë©”ì‹œì§€ ì„¤ì • í•¨ìˆ˜
    window.setMessage = function(message) {
      document.getElementById('message').value = message;
      document.getElementById('message').focus();
    };

    // ì±„íŒ… í¼ ì œì¶œ ì²˜ë¦¬
    const chatForm = document.getElementById('chat-form');
    const messageTextarea = document.getElementById('message');
    const sendButton = document.getElementById('send-button');

    chatForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const userMessage = messageTextarea.value.trim();
      if (!userMessage) return;

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      messageTextarea.value = '';
      messageTextarea.style.height = 'auto';

      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addUserMessage(userMessage);

      // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€ (ì‚¬ìš©ì ë©”ì‹œì§€ ë‹¤ìŒì—)
      setTimeout(() => {
        addLoadingMessage();
      }, 100);



      // AJAXë¡œ ë©”ì‹œì§€ ì „ì†¡
      fetch('/chatbot/api/chat/send/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          message: userMessage
        })
      })
      .then(response => response.json())
      .then(data => {

        if (data.success) {
          // ë‹¤ì–‘í•œ ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬
          let answer = '';
          let metadata = {};
          
          if (data.bot_message && data.bot_message.message) {
            answer = data.bot_message.message;
            metadata = data.bot_message.metadata || {};
          } else if (data.answer) {
            answer = data.answer;
            metadata = data.metadata || {};
          } else if (data.message) {
            answer = data.message;
            metadata = data.metadata || {};
          } else {

            answer = 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          }
          
          
          replaceLoadingWithAnswer(answer, metadata);
        } else {
          
          replaceLoadingWithAnswer('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        replaceLoadingWithAnswer('ì£„ì†¡í•©ë‹ˆë‹¤. ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    function addUserMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message mb-3 user-message';

      messageDiv.innerHTML = `
        <div class="d-flex justify-content-end">
          <div class="chat-bubble user-bubble">
            <div class="message-header mb-2">
              <span class="badge bg-primary">
                <i class="fas fa-user"></i>
                ì‚¬ìš©ì
              </span>
              <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="message-content">${message}</div>
          </div>
        </div>
      `;

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
    function addLoadingMessage() {
      const chatMessages = document.getElementById('chat-messages');
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-message';
      loadingDiv.className = 'chat-message mb-3 bot-message';

      loadingDiv.innerHTML = `
        <div class="d-flex">
          <div class="chat-bubble bot-bubble">
            <div class="message-header mb-2">
              <span class="badge bg-success">
                <i class="fas fa-robot"></i>
                ì±—ë´‡
              </span>
              <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="message-content">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                ë‹µë³€ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...
              </div>
            </div>
          </div>
        </div>
      `;

      chatMessages.appendChild(loadingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ë¡œë”© ë©”ì‹œì§€ë¥¼ ë‹µë³€ìœ¼ë¡œ êµì²´
    window.replaceLoadingWithAnswer = function(answer, metadata = {}) {
      
      
      const loadingMessage = document.getElementById('loading-message');
      if (!loadingMessage) {

        // ë¡œë”© ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ë©”ì‹œì§€ë¡œ ì¶”ê°€
        addBotMessage(answer, metadata);
        return;
      }

      const formattedAnswer = markdownToHtml(answer);
      
      
      loadingMessage.innerHTML = `
        <div class="d-flex">
          <div class="chat-bubble bot-bubble">
            <div class="message-header mb-2">
              <span class="badge bg-success">
                <i class="fas fa-robot"></i>
                ì±—ë´‡
              </span>
              <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="message-content">${formattedAnswer}</div>
            ${metadata.relevant_chunks_count ? `
              <div class="message-metadata mt-2">
                <details>
                  <summary class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    ë‹µë³€ ì •ë³´
                  </summary>
                  <div class="mt-2 p-2 bg-light rounded">
                    <small>
                      <strong>ì‚¬ìš©ëœ ë¬¸ì„œ:</strong>
                      ${metadata.relevant_chunks_count}ê°œ
                      <br />
                      <strong>ëª¨ë¸:</strong>
                      ${metadata.model_used || 'N/A'}
                      <br />
                      <strong>ìƒì„± ì‹œê°„:</strong>
                      ${metadata.generated_at ? new Date(metadata.generated_at).toLocaleString() : 'ì‹œê°„ ì •ë³´ ì—†ìŒ'}
                      ${metadata.cached ? '<br><strong>ìºì‹œ:</strong> ë¹ ë¥¸ ì‘ë‹µ' : ''}
                      ${metadata.contact_info_used ? '<br><strong>ì •ë³´:</strong> ì—°ë½ì²˜ ì •ë³´ ì„œë¹„ìŠ¤' : ''}
                    </small>
                  </div>
                </details>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      const chatMessages = document.getElementById('chat-messages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // ìë™ì™„ì„± ê¸°ëŠ¥
    const autoCompleteSuggestions = [
      'ìë™ì°¨ë³´í—˜ ì¶”ì²œí•´ì£¼ì„¸ìš”',
      'ë³´í—˜ê¸ˆ ì²­êµ¬ ì ˆì°¨ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?',
      'ê° ë³´í—˜ì‚¬ì˜ ì—°ë½ì²˜ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”',
      'ë¬´ë³´í—˜ìë™ì°¨ ì‚¬ê³ ì‹œ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?',
      'ë³´í—˜ í•´ì§€ ì ˆì°¨ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?',
      'ìë™ì°¨ë³´í—˜ í• ì¸ í˜œíƒì€ ë¬´ì—‡ì´ ìˆë‚˜ìš”?',
      'ì‚¬ê³  ë°œìƒì‹œ ì‹ ê³  ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”',
      'ë³´í—˜ë£Œ ê³„ì‚° ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”'
    ];

    let filteredSuggestions = [];
    let currentSuggestionIndex = -1;

    function showAutoCompleteSuggestions(input) {
      const value = input.value.toLowerCase();
      
      if (value.length < 2) {
        hideAutoCompleteSuggestions();
        return;
      }

      filteredSuggestions = autoCompleteSuggestions.filter(suggestion => 
        suggestion.toLowerCase().includes(value)
      );

      if (filteredSuggestions.length === 0) {
        hideAutoCompleteSuggestions();
        return;
      }

      // ê¸°ì¡´ ìë™ì™„ì„± ì œê±°
      hideAutoCompleteSuggestions();

      // ìƒˆë¡œìš´ ìë™ì™„ì„± ìƒì„±
      const autoCompleteDiv = document.createElement('div');
      autoCompleteDiv.id = 'auto-complete-suggestions';
      autoCompleteDiv.className = 'auto-complete-dropdown';

      filteredSuggestions.forEach((suggestion, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'auto-complete-item';
        suggestionDiv.textContent = suggestion;
        suggestionDiv.addEventListener('click', () => {
          messageTextarea.value = suggestion;
          hideAutoCompleteSuggestions();
          messageTextarea.focus();
        });
        autoCompleteDiv.appendChild(suggestionDiv);
      });

      // ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ì„ ì…ë ¥ í•„ë“œ ì•„ë˜ì— ì¶”ê°€
      const inputGroup = messageTextarea.closest('.input-group');
      inputGroup.appendChild(autoCompleteDiv);
    }

    function hideAutoCompleteSuggestions() {
      const existingAutoComplete = document.getElementById('auto-complete-suggestions');
      if (existingAutoComplete) {
        existingAutoComplete.remove();
      }
      currentSuggestionIndex = -1;
    }

    // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    messageTextarea.addEventListener('input', function () {
      showAutoCompleteSuggestions(this);
    });

    messageTextarea.addEventListener('focus', function () {
      if (this.value.length >= 2) {
        showAutoCompleteSuggestions(this);
      }
    });

    // ìë™ì™„ì„± í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
    messageTextarea.addEventListener('keydown', function (e) {
      const autoCompleteDiv = document.getElementById('auto-complete-suggestions');

      if (!autoCompleteDiv) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
        return;
      }

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, filteredSuggestions.length - 1);
          updateAutoCompleteSelection();
          break;
        case 'ArrowUp':
          e.preventDefault();
          currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
          updateAutoCompleteSelection();
          break;
        case 'Enter':
          e.preventDefault();
          if (currentSuggestionIndex >= 0 && filteredSuggestions[currentSuggestionIndex]) {
            this.value = filteredSuggestions[currentSuggestionIndex];
            hideAutoCompleteSuggestions();
            chatForm.dispatchEvent(new Event('submit'));
          } else {
            chatForm.dispatchEvent(new Event('submit'));
          }
          break;
        case 'Escape':
          hideAutoCompleteSuggestions();
          break;
      }
    });

    function updateAutoCompleteSelection() {
      const items = document.querySelectorAll('.auto-complete-item');
      items.forEach((item, index) => {
        if (index === currentSuggestionIndex) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.input-group')) {
        hideAutoCompleteSuggestions();
      }
    });

    // ë³´í—˜ ì¶”ì²œ í”„ë¡œí•„ ì…ë ¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
    window.showProfileInput = function() {
      document.getElementById('profile-input-bubble').style.display = 'block';
      document.getElementById('profile-input-bubble').scrollIntoView({ behavior: 'smooth' });
    };

    window.hideProfileInput = function() {
      document.getElementById('profile-input-bubble').style.display = 'none';
    };

    // í”„ë¡œí•„ í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('profile-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const profileData = {};
      
      for (let [key, value] of formData.entries()) {
        if (key === 'additional_coverage_interest') {
          profileData[key] = value === 'on';
        } else {
          profileData[key] = value;
        }
      }

      // í”„ë¡œí•„ ì •ë³´ ì €ì¥ ë° ë³´í—˜ ì¶”ì²œ ìš”ì²­
      fetch('/chatbot/api/insurance/profile/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(profileData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ë§í’ì„  ìˆ¨ê¸°ê¸°
          hideProfileInput();
          
          // ë³´í—˜ ì¶”ì²œ ê²°ê³¼ë¥¼ ì±„íŒ…ì— ì¶”ê°€
          if (data.recommendation) {
            const formattedResponse = formatInsuranceRecommendation(data.recommendation);
            addBotMessage(formattedResponse, {
              insurance_recommendation_requested: true,
              session_id: data.recommendation.session_id,
              recommendation_id: data.recommendation.recommendation_id,
              quotes_count: data.recommendation.quotes ? data.recommendation.quotes.length : 0,
              model_used: 'insurance_service',
              generated_at: new Date().toISOString()
            });
          }
          
          // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          showAlert('í”„ë¡œí•„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ì¶¤í˜• ë³´í—˜ ì¶”ì²œì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.', 'success');
        } else {
          showAlert('í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error, 'danger');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
      });
    });

    // ë³´í—˜ ì¶”ì²œ ê²°ê³¼ í¬ë§·íŒ… í•¨ìˆ˜
    function formatInsuranceRecommendation(result) {
      const quotes = result.quotes || [];
      if (quotes.length === 0) {
        return "ì£„ì†¡í•©ë‹ˆë‹¤. ì ì ˆí•œ ë³´í—˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }

      const topQuotes = quotes.slice(0, 3);
      let response = "ğŸ” **ìë™ì°¨ë³´í—˜ ì¶”ì²œ ê²°ê³¼**\n\n";

      topQuotes.forEach((quote, index) => {
        response += `**${index + 1}. ${quote.company}**\n`;
        response += `   ğŸ’° ì—°ê°„ ë³´í—˜ë£Œ: ${quote.annual_premium.toLocaleString()}ì›\n`;
        response += `   ğŸ“… ì›” ë‚©ì…ì•¡: ${quote.monthly_premium.toLocaleString()}ì›\n`;
        response += `   ğŸ›¡ï¸ ë³´ì¥ ìˆ˜ì¤€: ${quote.coverage_level}\n`;
        response += `   â­ ê³ ê° ë§Œì¡±ë„: ${quote.customer_satisfaction}/5.0\n`;
        
        if (quote.special_discount) {
          response += `   ğŸ íŠ¹ë³„ í• ì¸: ${quote.special_discount}\n`;
        }
        response += "\n";
      });

      const marketAnalysis = result.market_analysis || {};
      if (marketAnalysis.lowest_premium) {
        response += "ğŸ“Š **ì‹œì¥ ë¶„ì„**\n";
        response += `   â€¢ ìµœì €ê°€: ${marketAnalysis.lowest_premium.toLocaleString()}ì›\n`;
        response += `   â€¢ í‰ê· ê°€: ${marketAnalysis.average_premium.toLocaleString()}ì›\n`;
        response += `   â€¢ ê°€ì„±ë¹„ ìµœê³ : ${marketAnalysis.best_value || 'N/A'}\n\n`;
      }

      const userInfo = result.user_info || {};
      if (userInfo.risk_level) {
        response += "ğŸ‘¤ **ì‚¬ìš©ì ì •ë³´**\n";
        response += `   â€¢ ìœ„í—˜ë„: ${userInfo.risk_level}\n`;
        response += `   â€¢ ì¶”ì²œ ë³´ì¥: ${userInfo.recommended_coverage || 'N/A'}\n\n`;
      }

      response += "ğŸ’¡ **ì¶”ì²œ ì´ìœ **\n";
      response += result.recommendation_reason || "ê°œì¸ ë§ì¶¤í˜• ì¶”ì²œ";
      response += "\n\në” ìì„¸í•œ ì •ë³´ë‚˜ ë‹¤ë¥¸ ë³´í—˜ì‚¬ ê²¬ì ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”!";

      return response;
    }

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      const container = document.querySelector('.container');
      container.insertBefore(alertDiv, container.firstChild);
      
      // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê²Œ ì„¤ì •
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // ë´‡ ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ì™€ í†µí•©)
    function addBotMessage(message, metadata = {}) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message mb-3 bot-message';
      
      const formattedMessage = markdownToHtml(message);
      
      messageDiv.innerHTML = `
        <div class="d-flex">
          <div class="chat-bubble bot-bubble">
            <div class="message-header mb-2">
              <span class="badge bg-success">
                <i class="fas fa-robot"></i>
                ì±—ë´‡
              </span>
              <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="message-content">${formattedMessage}</div>
            ${metadata.insurance_recommendation_requested ? `
              <div class="message-metadata mt-2">
                <span class="badge bg-info">ë³´í—˜ ì¶”ì²œ</span>
                ${metadata.quotes_count ? `<span class="badge bg-secondary">${metadata.quotes_count}ê°œ ë³´í—˜ì‚¬</span>` : ''}
              </div>
            ` : ''}
            ${metadata.relevant_chunks_count ? `
              <div class="message-metadata mt-2">
                <details>
                  <summary class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    ë‹µë³€ ì •ë³´
                  </summary>
                  <div class="mt-2 p-2 bg-light rounded">
                    <small>
                      <strong>ì‚¬ìš©ëœ ë¬¸ì„œ:</strong>
                      ${metadata.relevant_chunks_count}ê°œ
                      <br />
                      <strong>ëª¨ë¸:</strong>
                      ${metadata.model_used || 'N/A'}
                      <br />
                      <strong>ìƒì„± ì‹œê°„:</strong>
                      ${metadata.generated_at ? new Date(metadata.generated_at).toLocaleString() : 'ì‹œê°„ ì •ë³´ ì—†ìŒ'}
                      ${metadata.cached ? '<br><strong>ìºì‹œ:</strong> ë¹ ë¥¸ ì‘ë‹µ' : ''}
                      ${metadata.contact_info_used ? '<br><strong>ì •ë³´:</strong> ì—°ë½ì²˜ ì •ë³´ ì„œë¹„ìŠ¤' : ''}
                    </small>
                  </div>
                </details>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ì±—ë´‡ ì‘ë‹µ ì²˜ë¦¬ ì‹œ ë§í’ì„  í‘œì‹œ ë¡œì§ ì¶”ê°€
    const originalReplaceLoadingWithAnswer = window.replaceLoadingWithAnswer;
    window.replaceLoadingWithAnswer = function(answer, metadata = {}) {
      const loadingMessage = document.getElementById('loading-message');
      if (!loadingMessage) return;

      // í”„ë¡œí•„ ì…ë ¥ ë§í’ì„  í‘œì‹œ ì—¬ë¶€ í™•ì¸
      if (metadata && metadata.show_profile_input) {
        // í”„ë¡œí•„ ì…ë ¥ ë§í’ì„  í‘œì‹œ
        showProfileInput();
      }

      const formattedAnswer = markdownToHtml(answer);
      
      loadingMessage.innerHTML = `
        <div class="d-flex">
          <div class="chat-bubble bot-bubble">
            <div class="message-header mb-2">
              <span class="badge bg-success">
                <i class="fas fa-robot"></i>
                ì±—ë´‡
              </span>
              <small class="text-muted ms-2">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="message-content">${formattedAnswer}</div>
            ${metadata.relevant_chunks_count ? `
              <div class="message-metadata mt-2">
                <details>
                  <summary class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    ë‹µë³€ ì •ë³´
                  </summary>
                  <div class="mt-2 p-2 bg-light rounded">
                    <small>
                      <strong>ì‚¬ìš©ëœ ë¬¸ì„œ:</strong>
                      ${metadata.relevant_chunks_count}ê°œ
                      <br />
                      <strong>ëª¨ë¸:</strong>
                      ${metadata.model_used || 'N/A'}
                      <br />
                      <strong>ìƒì„± ì‹œê°„:</strong>
                      ${metadata.generated_at ? new Date(metadata.generated_at).toLocaleString() : 'ì‹œê°„ ì •ë³´ ì—†ìŒ'}
                      ${metadata.cached ? '<br><strong>ìºì‹œ:</strong> ë¹ ë¥¸ ì‘ë‹µ' : ''}
                      ${metadata.contact_info_used ? '<br><strong>ì •ë³´:</strong> ì—°ë½ì²˜ ì •ë³´ ì„œë¹„ìŠ¤' : ''}
                    </small>
                  </div>
                </details>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      const chatMessages = document.getElementById('chat-messages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };
  });
</script>
{% endblock %}
